<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BSD Admin — Vendor Management</title>
<link rel="icon" type="image/x-icon" href="../favicon.ico">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Archivo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08090B;--bg2:#0E1014;--bg3:#151820;--bg4:#1C2029;--ember:#FF6B2C;--ember2:#E85A1E;--green:#34C759;--red:#E84545;--amber:#F5A623;--t1:#F2EDE6;--t2:#A0A4B0;--t3:#5E6270;--bd:rgba(255,255,255,.06);--smoke:#2A2D35}
body{font-family:'Archivo',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}

/* LOGIN */
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-box{width:100%;max-width:380px;background:var(--bg3);border:1px solid var(--bd);border-radius:20px;padding:40px;text-align:center}
.login-box img{width:60px;height:60px;border-radius:12px;margin-bottom:16px}
.login-box h1{font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin-bottom:4px}
.login-box p{font-size:13px;color:var(--t3);margin-bottom:24px}
.fg{margin-bottom:14px;text-align:left}
.fg label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:6px}
.fi{width:100%;height:46px;background:var(--bg);border:2px solid var(--smoke);border-radius:10px;padding:0 14px;font-size:14px;color:var(--t1);font-family:'Archivo',sans-serif;outline:none;transition:.2s}
.fi:focus{border-color:var(--ember);box-shadow:0 0 0 3px rgba(255,107,44,.1)}
.btn{width:100%;height:48px;background:var(--ember);border:none;border-radius:10px;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#fff;cursor:pointer;transition:.2s;margin-top:8px}
.btn:hover{background:var(--ember2)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.err{color:var(--red);font-size:12px;text-align:center;margin-bottom:8px;display:none}

/* DASHBOARD */
.dash{display:none}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 32px;border-bottom:1px solid var(--bd);background:var(--bg2)}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-left img{width:32px;height:32px;border-radius:8px}
.topbar-left span{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;text-transform:uppercase;letter-spacing:2px}
.topbar-left em{font-style:normal;color:var(--ember)}
.topbar-right{display:flex;align-items:center;gap:16px}
.topbar-user{font-size:12px;color:var(--t3)}
.btn-sm{padding:8px 16px;background:var(--smoke);border:none;border-radius:8px;font-size:12px;font-weight:600;color:var(--t2);cursor:pointer;transition:.2s}
.btn-sm:hover{background:var(--bg4);color:var(--t1)}

/* TABS */
.tabs{display:flex;gap:0;padding:0 32px;background:var(--bg2);border-bottom:1px solid var(--bd)}
.tab{padding:14px 24px;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t3);cursor:pointer;border-bottom:3px solid transparent;transition:.2s}
.tab.active{color:var(--ember);border-bottom-color:var(--ember)}
.tab:hover{color:var(--t1)}

/* CONTENT */
.content{padding:32px}
.panel{display:none}
.panel.active{display:block}

/* STATS ROW */
.stats-row{display:flex;gap:16px;margin-bottom:32px}
.stat-card{flex:1;background:var(--bg3);border:1px solid var(--bd);border-radius:14px;padding:20px 24px}
.stat-card .val{font-family:'Rajdhani',sans-serif;font-size:36px;font-weight:700;color:var(--ember)}
.stat-card .lbl{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--t3);margin-top:2px}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{text-align:left;padding:12px 16px;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--t3);border-bottom:1px solid var(--bd);font-weight:600}
.tbl td{padding:12px 16px;border-bottom:1px solid var(--bd);color:var(--t2)}
.tbl tr:hover td{background:rgba(255,255,255,.02)}
.badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.badge-pending{background:rgba(245,166,35,.15);color:var(--amber)}
.badge-approved{background:rgba(52,199,89,.15);color:var(--green)}
.badge-denied{background:rgba(232,69,69,.15);color:var(--red)}
.btn-approve{padding:6px 14px;background:var(--green);border:none;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#fff;cursor:pointer;transition:.2s}
.btn-approve:hover{opacity:.8}
.btn-approve:disabled{opacity:.4;cursor:not-allowed}
.btn-deny{padding:6px 14px;background:var(--red);border:none;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#fff;cursor:pointer;transition:.2s}
.btn-deny:hover{opacity:.8}
.actions{display:flex;gap:8px}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--bg3);border:1px solid var(--bd);border-radius:20px;padding:32px;max-width:500px;width:90%}
.modal h2{font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin-bottom:16px}
.modal-info{font-size:13px;color:var(--t2);line-height:1.6;margin-bottom:16px}
.modal-info strong{color:var(--t1)}
.cred-box{background:var(--bg);border:1px solid var(--bd);border-radius:10px;padding:16px;margin-bottom:16px;font-family:monospace;font-size:13px;color:var(--green);line-height:1.8;position:relative}
.copy-btn{position:absolute;top:8px;right:8px;padding:6px 12px;background:var(--smoke);border:none;border-radius:6px;font-size:11px;font-weight:600;color:var(--t2);cursor:pointer}
.copy-btn:hover{background:var(--bg4);color:var(--t1)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end}
.btn-modal{padding:10px 24px;border:none;border-radius:8px;font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:.2s}
.btn-close{background:var(--smoke);color:var(--t2)}
.btn-close:hover{background:var(--bg4);color:var(--t1)}

.empty{text-align:center;padding:48px;color:var(--t3);font-size:14px}

@media(max-width:768px){
  .stats-row{flex-direction:column}
  .content{padding:16px}
  .topbar{padding:12px 16px}
  .tabs{padding:0 16px;overflow-x:auto}
  .tbl{font-size:12px}
  .tbl th,.tbl td{padding:8px}
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-wrap" id="loginScreen">
  <div class="login-box">
    <img src="../logo.png" alt="BSD">
    <h1>Admin Panel</h1>
    <p>BlackStack Diesel — Vendor Management</p>
    <div class="err" id="loginErr"></div>
    <div class="fg">
      <label>Email</label>
      <input class="fi" type="email" id="loginEmail" placeholder="admin@black-stack-diesel.com">
    </div>
    <div class="fg">
      <label>Password</label>
      <input class="fi" type="password" id="loginPw" placeholder="••••••••">
    </div>
    <button class="btn" id="loginBtn" onclick="adminLogin()">Sign In</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dash" id="dashboard">
  <div class="topbar">
    <div class="topbar-left">
      <img src="../logo.png" alt="BSD">
      <span>Black<em>Stack</em> Admin</span>
    </div>
    <div class="topbar-right">
      <span class="topbar-user" id="adminEmail"></span>
      <button class="btn-sm" onclick="adminLogout()">Sign Out</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('applications',this)">Applications</div>
    <div class="tab" onclick="switchTab('vendors',this)">Active Vendors</div>
    <div class="tab" onclick="switchTab('waitlist',this)">Waitlist</div>
  </div>

  <div class="content">

    <!-- APPLICATIONS PANEL -->
    <div class="panel active" id="panel-applications">
      <div class="stats-row">
        <div class="stat-card"><div class="val" id="statPending">0</div><div class="lbl">Pending</div></div>
        <div class="stat-card"><div class="val" id="statApproved">0</div><div class="lbl">Approved</div></div>
        <div class="stat-card"><div class="val" id="statDenied">0</div><div class="lbl">Denied</div></div>
        <div class="stat-card"><div class="val" id="statTotal">0</div><div class="lbl">Total</div></div>
      </div>
      <table class="tbl">
        <thead><tr><th>Business</th><th>Contact</th><th>Email</th><th>Type</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="appRows"></tbody>
      </table>
      <div class="empty" id="appEmpty" style="display:none">No vendor applications yet.</div>
    </div>

    <!-- ACTIVE VENDORS PANEL -->
    <div class="panel" id="panel-vendors">
      <table class="tbl">
        <thead><tr><th>Business</th><th>Contact</th><th>Email</th><th>Type</th><th>Commission</th><th>Since</th></tr></thead>
        <tbody id="vendorRows"></tbody>
      </table>
      <div class="empty" id="vendorEmpty" style="display:none">No active vendors yet.</div>
    </div>

    <!-- WAITLIST PANEL -->
    <div class="panel" id="panel-waitlist">
      <table class="tbl">
        <thead><tr><th>Email</th><th>Signed Up</th></tr></thead>
        <tbody id="waitlistRows"></tbody>
      </table>
      <div class="empty" id="waitlistEmpty" style="display:none">No waitlist signups yet.</div>
    </div>

  </div>
</div>

<!-- APPROVE MODAL -->
<div class="modal-overlay" id="approveModal">
  <div class="modal">
    <h2>✅ Vendor Approved</h2>
    <div class="modal-info" id="modalInfo"></div>
    <div class="cred-box" id="credBox">
      <button class="copy-btn" onclick="copyCreds()">Copy</button>
    </div>
    <p style="font-size:12px;color:var(--t3);margin-bottom:16px">Send these credentials to the vendor. They can change their password after first login.</p>
    <div class="modal-actions">
      <button class="btn-modal btn-close" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
const SUPA_URL='https://jfjbilfsiebifzddveof.supabase.co';
const SUPA_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmamJpbGZzaWViaWZ6ZGR2ZW9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2OTg4ODUsImV4cCI6MjA4NzI3NDg4NX0.bbTQ0l4HsHoKUzoKACBvbXJ0TbnUM5tltK4YLKyuMr8';
const sb=supabase.createClient(SUPA_URL,SUPA_ANON);

// ADMIN EMAIL - change this to your email
const ADMIN_EMAILS=['nicholas.antel@outlook.com','help@black-stack-diesel.com'];

let currentUser=null;

// LOGIN
async function adminLogin(){
  var email=document.getElementById('loginEmail').value.trim();
  var pw=document.getElementById('loginPw').value;
  var errEl=document.getElementById('loginErr');
  if(!email||!pw){errEl.textContent='Enter email and password.';errEl.style.display='block';return}
  document.getElementById('loginBtn').textContent='Signing in...';
  document.getElementById('loginBtn').disabled=true;
  var{data,error}=await sb.auth.signInWithPassword({email:email,password:pw});
  if(error){errEl.textContent=error.message;errEl.style.display='block';document.getElementById('loginBtn').textContent='Sign In';document.getElementById('loginBtn').disabled=false;return}
  if(!ADMIN_EMAILS.includes(data.user.email)){errEl.textContent='Access denied. Admin accounts only.';errEl.style.display='block';await sb.auth.signOut();document.getElementById('loginBtn').textContent='Sign In';document.getElementById('loginBtn').disabled=false;return}
  currentUser=data.user;
  showDashboard();
}

async function adminLogout(){await sb.auth.signOut();currentUser=null;document.getElementById('dashboard').style.display='none';document.getElementById('loginScreen').style.display='flex'}

function showDashboard(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('dashboard').style.display='block';
  document.getElementById('adminEmail').textContent=currentUser.email;
  loadApplications();
  loadVendors();
  loadWaitlist();
}

// CHECK SESSION
async function checkSession(){
  var{data:{session}}=await sb.auth.getSession();
  if(session&&ADMIN_EMAILS.includes(session.user.email)){currentUser=session.user;showDashboard()}
}
checkSession();

// TABS
function switchTab(id,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-'+id).classList.add('active');
}

// LOAD APPLICATIONS
async function loadApplications(){
  var{data,error}=await sb.from('vendor_applications').select('*').order('created_at',{ascending:false});
  if(error||!data){document.getElementById('appEmpty').style.display='block';return}
  var pending=data.filter(d=>d.status==='pending').length;
  var approved=data.filter(d=>d.status==='approved').length;
  var denied=data.filter(d=>d.status==='denied').length;
  document.getElementById('statPending').textContent=pending;
  document.getElementById('statApproved').textContent=approved;
  document.getElementById('statDenied').textContent=denied;
  document.getElementById('statTotal').textContent=data.length;
  var tbody=document.getElementById('appRows');
  tbody.innerHTML='';
  if(!data.length){document.getElementById('appEmpty').style.display='block';return}
  document.getElementById('appEmpty').style.display='none';
  data.forEach(function(app){
    var badgeClass=app.status==='pending'?'badge-pending':app.status==='approved'?'badge-approved':'badge-denied';
    var date=new Date(app.created_at).toLocaleDateString();
    var actions='';
    if(app.status==='pending'){
      actions='<div class="actions"><button class="btn-approve" onclick="approveVendor(\''+app.id+'\',\''+app.email+'\',\''+app.business_name.replace(/'/g,"\\'")+'\',\''+app.contact_name.replace(/'/g,"\\'")+'\')">Approve</button><button class="btn-deny" onclick="denyVendor(\''+app.id+'\')">Deny</button></div>';
    }else if(app.status==='approved'){
      actions='<span style="color:var(--green);font-size:12px">✓ Done</span>';
    }else{
      actions='<span style="color:var(--red);font-size:12px">✗ Denied</span>';
    }
    tbody.innerHTML+='<tr><td><strong style="color:var(--t1)">'+app.business_name+'</strong></td><td>'+app.contact_name+'</td><td>'+app.email+'</td><td>'+(app.business_type||'—')+'</td><td><span class="badge '+badgeClass+'">'+app.status+'</span></td><td>'+date+'</td><td>'+actions+'</td></tr>';
  });
}

// APPROVE VENDOR
async function approveVendor(appId,email,bizName,contactName){
  var btn=event.target;
  btn.textContent='Creating...';
  btn.disabled=true;

  // Generate random password
  var chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$';
  var password='';
  for(var i=0;i<12;i++)password+=chars.charAt(Math.floor(Math.random()*chars.length));

  try{
    // Create auth account
    var{data:authData,error:authErr}=await sb.auth.signUp({email:email,password:password,options:{data:{role:'vendor',business_name:bizName}}});
    if(authErr)throw authErr;

    // Add to vendors table
    var{error:vendorErr}=await sb.from('vendors').insert({
      user_id:authData.user?authData.user.id:null,
      business_name:bizName,
      contact_name:contactName,
      email:email,
      business_type:null,
      commission_rate:0.12
    });

    // Update application status
    await sb.from('vendor_applications').update({status:'approved'}).eq('id',appId);

    // Show credentials modal
    document.getElementById('modalInfo').innerHTML='<strong>'+bizName+'</strong> has been approved and their account has been created.';
    document.getElementById('credBox').innerHTML='<button class="copy-btn" onclick="copyCreds()">Copy</button>'
      +'Email: '+email+'\n'
      +'Password: '+password+'\n'
      +'Login: https://www.black-stack-diesel.com/vendors/';
    document.getElementById('approveModal').classList.add('show');

    loadApplications();
  }catch(err){
    alert('Error: '+err.message);
    btn.textContent='Approve';
    btn.disabled=false;
  }
}

// DENY VENDOR
async function denyVendor(appId){
  if(!confirm('Deny this vendor application?'))return;
  await sb.from('vendor_applications').update({status:'denied'}).eq('id',appId);
  loadApplications();
}

// COPY CREDENTIALS
function copyCreds(){
  var text=document.getElementById('credBox').innerText.replace('Copy','').trim();
  navigator.clipboard.writeText(text);
  document.querySelector('.copy-btn').textContent='Copied!';
  setTimeout(function(){document.querySelector('.copy-btn').textContent='Copy'},2000);
}

function closeModal(){document.getElementById('approveModal').classList.remove('show')}

// LOAD VENDORS
async function loadVendors(){
  var{data,error}=await sb.from('vendors').select('*').order('created_at',{ascending:false});
  var tbody=document.getElementById('vendorRows');
  tbody.innerHTML='';
  if(!data||!data.length){document.getElementById('vendorEmpty').style.display='block';return}
  document.getElementById('vendorEmpty').style.display='none';
  data.forEach(function(v){
    var date=new Date(v.created_at).toLocaleDateString();
    tbody.innerHTML+='<tr><td><strong style="color:var(--t1)">'+v.business_name+'</strong></td><td>'+v.contact_name+'</td><td>'+v.email+'</td><td>'+(v.business_type||'—')+'</td><td>'+(v.commission_rate*100)+'%</td><td>'+date+'</td></tr>';
  });
}

// LOAD WAITLIST
async function loadWaitlist(){
  var{data,error}=await sb.from('waitlist').select('*').order('created_at',{ascending:false});
  var tbody=document.getElementById('waitlistRows');
  tbody.innerHTML='';
  if(!data||!data.length){document.getElementById('waitlistEmpty').style.display='block';return}
  document.getElementById('waitlistEmpty').style.display='none';
  data.forEach(function(w){
    var date=new Date(w.created_at).toLocaleDateString();
    tbody.innerHTML+='<tr><td>'+w.email+'</td><td>'+date+'</td></tr>';
  });
}
</script>
</body>
</html>
